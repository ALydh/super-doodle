version: '3.8'

services:
  # Primary: GraalVM Native Image
  app-native:
    build:
      context: .
      dockerfile: Dockerfile.native
    ports:
      - "8080:8080"
    volumes:
      - ./data:/app/data:rw
      - ./db:/app/db:rw
      - ./logs:/app/logs:rw
    environment:
      - JAVA_OPTS=-XX:MaxRAMPercentage=60
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s

  # Fallback: JVM (commented out by default)
  # app-jvm:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile.jvm
  #   ports:
  #     - "8081:8080"
  #   volumes:
  #     - ./data:/app/data:rw
  #     - ./db:/app/db:rw
  #     - ./logs:/app/logs:rw
  #   environment:
  #     - JAVA_OPTS=-XX:MaxRAMPercentage=60
  #   restart: unless-stopped
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 512M
  #       reservations:
  #         memory: 256M

networks:
  default:
    name: wahapedia-network