name: Deploy

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}
      deploy: ${{ steps.filter.outputs.deploy }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            frontend:
              - 'frontend/**'
            backend:
              - 'backend/**'
              - 'data/**'
            deploy:
              - 'deploy/**'

  build-frontend:
    needs: changes
    if: needs.changes.outputs.frontend == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Build frontend
        run: cd frontend && npm ci && npm run build

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist

  build-backend:
    needs: changes
    if: needs.changes.outputs.backend == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup GraalVM
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'graalvm'

      - name: Cache sbt
        uses: actions/cache@v4
        with:
          path: |
            ~/.sbt
            ~/.cache/coursier
          key: sbt-${{ hashFiles('backend/build.sbt', 'backend/project/*.sbt', 'backend/project/build.properties') }}
          restore-keys: sbt-

      - name: Setup sbt
        uses: sbt/setup-sbt@v1

      - name: Build reference database
        run: cd backend && sbt "runMain wahapedia.BuildRefDb ../data/wahapedia wahapedia-ref.db"

      - name: Build native image
        run: cd backend && sbt nativeImage
        env:
          GRAALVM_HOME: ${{ env.JAVA_HOME }}

      - name: Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-dist
          path: |
            backend/target/native-image/backend
            backend/wahapedia-ref.db

  deploy:
    needs: [changes, build-frontend, build-backend]
    if: always() && !failure() && !cancelled()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: deploy

      - name: Download frontend artifact
        if: needs.build-frontend.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist

      - name: Download backend artifact
        if: needs.build-backend.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: backend-dist
          path: backend

      - name: Stop service
        if: needs.build-backend.result == 'success'
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: sudo systemctl stop wp40k || true

      - name: Copy frontend
        if: needs.build-frontend.result == 'success'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "frontend/dist/*"
          target: "/opt/wp40k/frontend"
          strip_components: 2

      - name: Copy backend
        if: needs.build-backend.result == 'success'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "backend/target/native-image/backend,backend/wahapedia-ref.db"
          target: "/opt/wp40k"
          strip_components: 1

      - name: Copy deploy configs
        if: needs.changes.outputs.deploy == 'true' || github.event_name == 'workflow_dispatch'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "deploy/*"
          target: "/opt/wp40k/deploy"
          strip_components: 1

      - name: Finalize deployment
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /opt/wp40k
            if [ -f target/native-image/backend ]; then
              mv target/native-image/backend backend
              chmod +x backend
            fi
            if [ -f wahapedia-ref.db ]; then
              mv wahapedia-ref.db wahapedia-ref.db.new && mv wahapedia-ref.db.new wahapedia-ref.db
            fi
            rm -rf target
            sudo systemctl start wp40k
            cd /opt/wp40k/deploy && docker compose -f docker-compose.observability.yml up -d --pull always || true
